<div class="training-container">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <span>Digital Skilling</span>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-title">Main</div>
      <a href="#" class="nav-item active" routerLink="/dashboard">
        <i class="fas fa-th-large"></i>
        <span>Dashboard</span>
      </a>
      <a href="#" class="nav-item" routerLink="/profile">
        <i class="fas fa-user"></i>
        <span>My Profile</span>
      </a>
      <a href="#" class="nav-item" routerLink="../job-explorer">
        <i class="fas fa-briefcase"></i>
        <span>Jobs Explorer</span>
        <span class="nav-badge">5</span>
      </a>
      <a href="#" class="nav-item" routerLink="/ai-recommendations">
        <i class="fas fa-robot"></i>
        <span>AI Recommendations</span>
      </a>
      <a href="#" class="nav-item" routerLink="/cv-manager">
        <i class="fas fa-file-alt"></i>
        <span>CV Manager</span>
      </a>
      <a href="#" class="nav-item" routerLink="/portfolio">
        <i class="fas fa-folder"></i>
        <span>My Portfolio</span>
      </a>
      <a href="#" class="nav-item" routerLink="../training">
        <i class="fas fa-play-circle"></i>
        <span>Training</span>
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-title">Support</div>
      <a href="#" class="nav-item" routerLink="/settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
      <a href="#" class="nav-item" routerLink="/help">
        <i class="fas fa-question-circle"></i>
        <span>Help & Support</span>
      </a>
    </div>
  </nav>

  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1><i class="fas fa-graduation-cap"></i> Training Opportunities</h1>
        <p>Gain skills through curated video-based training programs tailored for career growth.</p>
      </div>
      <div class="header-stats">
        <div class="stat-card">
          <i class="fas fa-video"></i>
          <div>
            <span class="stat-number">150+</span>
            <span class="stat-label">Video Courses</span>
          </div>
        </div>
        <div class="stat-card">
          <i class="fas fa-certificate"></i>
          <div>
            <span class="stat-number">85%</span>
            <span class="stat-label">Certificate Rate</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Bell -->
  <div class="notification-wrapper">
    <button class="notification-bell" (click)="toggleNotifications()">
      <i class="fas fa-bell"></i>
      <span class="notification-badge" *ngIf="unreadNotificationCount > 0">
        {{ unreadNotificationCount }}
      </span>
    </button>
    
    <!-- Notification Dropdown -->
    <div class="notification-dropdown" *ngIf="showNotifications">
      <div class="notification-header">
        <h3>Notifications</h3>
        <button class="close-btn" (click)="toggleNotifications()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="notification-list">
        <div class="notification-item" 
             *ngFor="let notification of notifications"
             (click)="markNotificationAsRead(notification.id)">
          <div class="notification-icon">
            <i class="fas fa-bell" [style.color]="notification.type === 'certificate_issued' ? 'gold' : 'blue'"></i>
          </div>
          <div class="notification-content">
            <p class="notification-message">{{ notification.message }}</p>
            <span class="notification-time">{{ notification.created_at | date:'short' }}</span>
          </div>
          
          <!-- Certificate Download Button -->
          <button 
            *ngIf="notification.type === 'certificate_issued'"
            class="btn-download-cert"
            (click)="downloadCertificate(notification.metadata.enrollment_id, 'training'); $event.stopPropagation()">
            <i class="fas fa-download"></i>
            Download
          </button>
        </div>
        
        <div class="no-notifications" *ngIf="notifications.length === 0">
          <i class="fas fa-inbox"></i>
          <p>No new notifications</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Search training programs..." 
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()">
      </div>
      <button class="filter-toggle-btn" (click)="toggleFilters()">
        <i class="fas fa-filter"></i>
        Filters
        <i class="fas fa-chevron-down" [class.rotated]="showFilters"></i>
      </button>
    </div>

    <!-- Advanced Filters -->
    <div class="filters-panel" [class.show]="showFilters">
      <div class="filter-group">
        <h4>Duration</h4>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('duration', 'short', $event)"> Short (< 10 hours)</label>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('duration', 'medium', $event)"> Medium (10-40 hours)</label>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('duration', 'long', $event)"> Long (> 40 hours)</label>
      </div>
      <div class="filter-group">
        <h4>Level</h4>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('level', 'Beginner', $event)"> Beginner</label>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('level', 'Intermediate', $event)"> Intermediate</label>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('level', 'Advanced', $event)"> Advanced</label>
      </div>
      <div class="filter-group">
        <h4>Cost</h4>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('cost', 'Free', $event)"> Free</label>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('cost', 'Paid', $event)"> Paid</label>
      </div>
      <div class="filter-group">
        <h4>Mode</h4>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('mode', 'Online', $event)"> Online</label>
        <label><input type="checkbox" (change)="onFilterCheckboxChange('mode', 'Offline', $event)"> Offline</label>
      </div>
      <button class="clear-filters-btn" (click)="clearAllFilters()">
        <i class="fas fa-times"></i> Clear All
      </button>
    </div>
  </div>

  <!-- Category Tabs -->
  <div class="category-tabs">
    <button 
      class="category-tab" 
      [class.active]="selectedCategory === 'all'"
      (click)="filterByCategory('all')">
      All Courses
    </button>
    <button 
      *ngFor="let category of categories"
      class="category-tab" 
      [class.active]="selectedCategory === category"
      (click)="filterByCategory(category)">
      {{category}}
    </button>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading training programs...</p>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !loading">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Error Loading Trainings</h3>
      <p>{{error}}</p>
      <button class="btn btn-primary" (click)="refreshTrainings()">
        <i class="fas fa-refresh"></i>
        Try Again
      </button>
    </div>
  </div>

  <!-- Training Grid -->
  <div class="training-grid" *ngIf="!loading && !error">
    <div class="training-card" *ngFor="let training of filteredTrainings">
      <div class="card-header">
        <div class="card-image">
          <img [src]="training.thumbnail_url || 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=300&h=200&fit=crop'" 
               [alt]="training.title">
          <div class="video-overlay">
            <i class="fas fa-play"></i>
            <span>{{ training.video_count || training.videos?.length || 0 }} Videos</span>
          </div>
          <div class="duration-badge">{{formatDuration(training.duration_hours)}}</div>
        </div>
        <div class="card-actions">
          <!-- FIXED: Wishlist toggle with icon change -->
          <button class="action-btn" title="Add to Wishlist" (click)="toggleWishlist(training.id)">
            <i class="far fa-heart" *ngIf="!isInWishlist(training.id)"></i>
            <i class="fas fa-heart" *ngIf="isInWishlist(training.id)" style="color: red;"></i>
          </button>
          <!-- FIXED: Share button -->
          <button class="action-btn" title="Share" (click)="shareTraining(training)">
            <i class="fas fa-share"></i>
          </button>
        </div>
      </div>

      <div class="card-content">
        <div class="card-meta">
          <span class="category-tag">{{training.category}}</span>
          <span class="level-badge" [class]="training.level.toLowerCase()">{{training.level}}</span>
        </div>
        
        <h3 class="card-title">{{training.title}}</h3>
        <p class="card-description">{{training.description}}</p>
        
        <div class="card-details">
          <div class="detail-item">
            <i class="fas fa-building"></i>
            <span>{{training.provider_name}}</span>
          </div>
          <div class="detail-item">
            <i class="fas fa-users"></i>
            <span>{{training.total_students | number}} students</span>
          </div>
          <div class="detail-item">
            <i class="fas fa-star"></i>
            <span>{{training.rating}}</span>
          </div>
        </div>

        <div class="card-features">
          <div class="feature" *ngIf="training.has_certificate">
            <i class="fas fa-certificate"></i>
            <span>Certificate</span>
          </div>
          <div class="feature">
            <i class="fas fa-globe" *ngIf="training.mode === 'Online'; else offlineIcon"></i>
            <ng-template #offlineIcon><i class="fas fa-map-marker-alt"></i></ng-template>
            <span>{{training.mode}}</span>
          </div>
          <div class="feature" [class.free]="training.cost_type === 'Free'">
            <i class="fas fa-tag"></i>
            <span>{{formatPrice(training)}}</span>
          </div>
        </div>

        <!-- Progress Bar (for enrolled courses) -->
        <div class="progress-section" *ngIf="training.enrolled">
          <div class="progress-info">
            <span>Progress</span>
            <span>{{getTrainingProgress(training)}}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width]="getProgressWidth(getTrainingProgress(training))"></div>
          </div>
        </div>

        <!-- Certificate Button -->
        <button 
          *ngIf="training.enrolled && training.certificate_issued"
          class="btn-certificate"
          (click)="downloadCertificate(training.enrollment_id, training.title)">
          <i class="fas fa-certificate"></i>
          Download Certificate
        </button>
      </div>

      <div class="card-footer">
        <button 
          class="btn btn-outline" 
          (click)="viewTrainingDetail(training)">
          <i class="fas fa-info-circle"></i>
          View Details
        </button>
        <button 
          *ngIf="!training.enrolled; else continueBtn"
          class="btn btn-primary" 
          (click)="enrollInTraining(training)"
          [disabled]="loading">
          <i class="fas fa-plus-circle"></i>
          Enroll Now
        </button>
        <ng-template #continueBtn>
          <button 
            class="btn btn-success" 
            (click)="startTraining(training)">
            <i class="fas fa-play"></i>
            Continue
          </button>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Add Pagination -->
  <div class="pagination-container" *ngIf="!loading && !error && totalPages > 1">
    <div class="pagination-info">
      <span>Showing {{((currentPage - 1) * pageSize) + 1}} to {{Math.min(currentPage * pageSize, totalCount)}} of {{totalCount}} trainings</span>
    </div>
    
    <div class="pagination-controls">
      <button 
        class="pagination-btn" 
        [disabled]="currentPage === 1"
        (click)="previousPage()">
        <i class="fas fa-chevron-left"></i>
        Previous
      </button>
      
      <div class="pagination-numbers">
        <button 
          *ngFor="let page of getPaginationPages()"
          class="pagination-number"
          [class.active]="page === currentPage"
          [disabled]="page === '...'"
          (click)="page !== '...' ? goToPage(+page) : null">
          {{page}}
        </button>
      </div>
      
      <button 
        class="pagination-btn" 
        [disabled]="currentPage === totalPages"
        (click)="nextPage()">
        Next
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- No Results -->
  <div class="no-results" *ngIf="!loading && !error && filteredTrainings.length === 0">
    <div class="no-results-content">
      <i class="fas fa-search"></i>
      <h3>No Training Programs Found</h3>
      <p>No trainings match your current search criteria.</p>
      <div class="no-results-actions">
        <button class="btn btn-primary" (click)="clearAllFilters()">
          <i class="fas fa-refresh"></i>
          Clear Filters
        </button>
        <button class="btn btn-outline" (click)="refreshTrainings()">
          <i class="fas fa-sync"></i>
          Refresh
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Training Detail Modal -->
<div class="modal-overlay" *ngIf="showTrainingDetail" (click)="closeTrainingDetail()">
  <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="selectedTraining">
    <div class="modal-header">
      <h2>{{selectedTraining.title}}</h2>
      <button class="close-btn" (click)="closeTrainingDetail()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="training-overview">
        <img [src]="selectedTraining.thumbnail_url || 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=300&h=200&fit=crop'" 
             [alt]="selectedTraining.title" class="training-image">
        <div class="training-info">
          <p class="training-description">{{selectedTraining.description}}</p>
          
          <div class="training-stats">
            <div class="stat">
              <i class="fas fa-clock"></i>
              <span>{{formatDuration(selectedTraining.duration_hours)}}</span>
            </div>
            <div class="stat">
              <i class="fas fa-signal"></i>
              <span>{{selectedTraining.level}}</span>
            </div>
            <div class="stat">
              <i class="fas fa-star"></i>
              <span>{{selectedTraining.rating}} rating</span>
            </div>
            <div class="stat">
              <i class="fas fa-users"></i>
              <span>{{selectedTraining.total_students | number}} students</span>
            </div>
          </div>
        </div>
      </div>

      <div class="training-sections">
        <!-- Outcomes Section -->
        <div class="section">
          <h3><i class="fas fa-target"></i> Learning Outcomes</h3>
          <ul class="outcomes-list">
            <li *ngFor="let outcome of selectedTraining.outcomes">
              <i class="fas fa-check-circle"></i>
              {{outcome.outcome_text}}
            </li>
          </ul>
        </div>

         <div class="section">
          <h3><i class="fas fa-play-circle"></i> Course Videos ({{selectedTraining.videos?.length || selectedTraining.video_count || 0}})</h3>
          
          <!-- NEW: Video loading state -->
          <div *ngIf="showVideoLoading" class="video-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading videos...</p>
          </div>
          
          <div class="video-list" *ngIf="!showVideoLoading">
            
            <div class="video-item" 
                 *ngFor="let video of selectedTraining?.videos; let i = index"
                 [class.clickable]="true"
                 (click)="playVideo(video, i); $event.stopPropagation()">
              <div class="video-number">{{i + 1}}</div>
              <div class="video-info">
                <h4>{{video.title}}</h4>
                <span class="video-duration">
                  <i class="fas fa-clock"></i>
                  {{video.duration_minutes || 0}} mins
                </span>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                  URL: {{video.video_url ? (video.video_url.substring(0, 40) + '...') : 'NO URL'}}
                </div>
              </div>
              <div class="video-status">
                <i class="fas fa-check-circle" *ngIf="video.completed" style="color: #10b981;"></i>
                <button class="play-video-btn" 
                        (click)="playVideo(video, i); $event.stopPropagation()"
                        type="button">
                  <i class="fas fa-play-circle"></i>
                  Play
                </button>
              </div>
            </div>
    
    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeTrainingDetail()">
        Close
      </button>
      <button 
        *ngIf="!selectedTraining.enrolled; else continueBtnModal"
        class="btn btn-primary" 
        (click)="enrollInTraining(selectedTraining); closeTrainingDetail()">
        <i class="fas fa-plus-circle"></i>
        Enroll Now
      </button>
      <ng-template #continueBtnModal>
        <button 
          class="btn btn-success" 
          (click)="startTraining(selectedTraining); closeTrainingDetail()">
          <i class="fas fa-play"></i>
          Start Learning
        </button>
      </ng-template>
    </div>
  </div>

  <div class="video-player-modal" *ngIf="showVideoPlayer" (click)="closeVideoPlayer()">
  <div class="video-player-container" (click)="$event.stopPropagation()">
    <div class="video-player-header">
      <div class="video-player-title">
        <h3>{{ currentVideo?.title }}</h3>
        <span class="video-counter" *ngIf="selectedTraining.videos?.length">
          Video {{ (currentVideoIndex || 0) + 1 }} of {{ selectedTraining.videos?.length }}
        </span>
      </div>
      <button class="close-video-btn" (click)="closeVideoPlayer()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="video-player-content">
      <!-- Video Frame -->
      <div class="video-wrapper">
        <iframe 
          #videoPlayer
          *ngIf="safeVideoUrl"
          [src]="safeVideoUrl" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen
          class="video-iframe">
        </iframe>
      </div>

      <!-- Progress Indicator -->
      <div class="video-progress-indicator">
        <div class="watch-time">
          <i class="fas fa-clock"></i>
          <span>Watch time: {{ formatDuration(Math.floor(videoWatchTime / 60)) }}</span>
        </div>
        <button class="btn-mark-complete" (click)="markVideoComplete()">
          <i class="fas fa-check-circle"></i>
          Mark as Complete
        </button>
      </div>

      <!-- Video Controls -->
      <div class="video-controls">
        <button 
          class="video-nav-btn" 
          [disabled]="currentVideoIndex === 0"
          (click)="playPreviousVideo()">
          <i class="fas fa-chevron-left"></i>
          Previous
        </button>
        
        <div class="video-info">
          <span class="video-duration" *ngIf="currentVideo">
            <i class="fas fa-clock"></i>
            {{ currentVideo.duration_minutes || 0 }} mins
          </span>
        </div>
        
        <button 
            class="video-nav-btn" 
            [disabled]="!selectedTraining.videos || currentVideoIndex === ((selectedTraining.videos.length || 0) - 1)"
            (click)="playNextVideo()">
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
      </div>

      <!-- Video Playlist -->
      <div class="video-playlist" *ngIf="(selectedTraining?.videos?.length || 0) > 1">
        <h4>Course Videos</h4>
        <div class="playlist-items">
          <div 
            class="playlist-item" 
            *ngFor="let video of selectedTraining?.videos; let i = index"
            [class.active]="i === currentVideoIndex"
            [class.completed]="video.completed"
            (click)="playVideo(video, i)">
            <div class="playlist-number">{{ i + 1 }}</div>
            <div class="playlist-info">
              <span class="playlist-title">{{ video.title }}</span>
              <span class="playlist-duration">{{ video.duration_minutes || 0 }} mins</span>
            </div>
            <div class="playlist-status">
              <i class="fas fa-check-circle" *ngIf="video.completed" style="color: #10b981;"></i>
              <i class="fas fa-play-circle" *ngIf="!video.completed" style="color: #6b7280;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</div>